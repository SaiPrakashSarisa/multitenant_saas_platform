// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// CORE MULTI-TENANT TABLES
// ============================================

model Plan {
  id            String   @id @default(uuid())
  name          String   @unique // 'basic', 'pro', 'enterprise'
  displayName   String
  price         Decimal  @db.Decimal(10, 2)
  billingCycle  String   // 'monthly', 'yearly'
  features      Json     // Store plan limits: {"maxProducts": 100, "maxUsers": 5}
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenants Tenant[]

  @@map("plans")
}

model Tenant {
  id              String    @id @default(uuid())
  name            String
  slug            String    @unique
  businessType    String    // 'inventory', 'hotel', 'landing', 'expense'
  planId          String
  status          String    @default("trial") // 'trial', 'active', 'suspended', 'expired'
  customLimits    Json?     // Override plan limits for specific tenants
  trialStartDate  DateTime? // When trial started
  trialEndDate    DateTime? // When trial ends (2 months from start)
  trialConverted  Boolean   @default(false) // Did they convert to paid plan?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  plan            Plan             @relation(fields: [planId], references: [id])
  users           User[]
  tenantModules   TenantModule[]
  products        Product[]
  stockMovements  StockMovement[]
  hotelTables     HotelTable[]
  reservations    Reservation[]
  expenses        Expense[]
  landingPages    LandingPage[]
  pageAssets      PageAsset[]
  rolePermissions RolePermission[]
  
  // E-commerce relations
  ecommerceCategories EcommerceCategory[]
  ecommerceProducts   EcommerceProduct[]
  ecommerceCarts      EcommerceCart[]
  ecommerceOrders     EcommerceOrder[]
  ecommerceCoupons    EcommerceCoupon[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String
  email        String   @unique
  passwordHash String
  role         String   // 'owner', 'admin', 'staff'
  firstName    String?
  lastName     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  products       Product[]
  stockMovements StockMovement[]
  expenses       Expense[]
  
  // E-commerce relations
  ecommerceCarts  EcommerceCart[]
  ecommerceOrders EcommerceOrder[]

  @@map("users")
}

model Module {
  id          String   @id @default(uuid())
  name        String   @unique // 'inventory', 'hotel', 'expenses', 'landing'
  displayName String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  tenantModules TenantModule[]
  permissions   Permission[]

  @@map("modules")
}

model TenantModule {
  id        String   @id @default(uuid())
  tenantId  String
  moduleId  String
  isEnabled Boolean  @default(true)
  config    Json?    // Module-specific settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  module Module @relation(fields: [moduleId], references: [id])

  @@unique([tenantId, moduleId])
  @@map("tenant_modules")
}

model Permission {
  id            String  @id @default(uuid())
  name          String  @unique // 'inventory.create', 'hotel.view'
  moduleId      String?
  description   String?
  minPlanLevel  String? // 'basic', 'pro', 'enterprise'

  module          Module?           @relation(fields: [moduleId], references: [id])
  rolePermissions RolePermission[]

  @@map("permissions")
}

model RolePermission {
  id           String @id @default(uuid())
  tenantId     String
  role         String // 'owner', 'admin', 'staff'
  permissionId String

  tenant     Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([tenantId, role, permissionId])
  @@map("role_permissions")
}

// ============================================
// INVENTORY MODULE TABLES
// ============================================

model Product {
  id                String   @id @default(uuid())
  tenantId          String
  name              String
  sku               String?
  description       String?
  price             Decimal? @db.Decimal(10, 2)
  stockQuantity     Int      @default(0)
  lowStockThreshold Int      @default(10)
  category          String?
  imageUrl          String?
  createdBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator        User?           @relation(fields: [createdBy], references: [id])
  stockMovements StockMovement[]

  @@index([tenantId])
  @@map("products")
}

model StockMovement {
  id           String   @id @default(uuid())
  tenantId     String
  productId    String
  quantity     Int // Positive for addition, negative for deduction
  movementType String // 'purchase', 'sale', 'adjustment', 'return'
  notes        String?
  createdBy    String?
  createdAt    DateTime @default(now())

  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  creator User?   @relation(fields: [createdBy], references: [id])

  @@index([tenantId, productId])
  @@map("stock_movements")
}

// ============================================
// HOTEL MODULE TABLES
// ============================================

model HotelTable {
  id          String   @id @default(uuid())
  tenantId    String
  tableNumber String
  capacity    Int?
  status      String   @default("available") // 'available', 'occupied', 'reserved', 'maintenance'
  floor       String?
  section     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  reservations Reservation[]

  @@unique([tenantId, tableNumber])
  @@index([tenantId])
  @@map("hotel_tables")
}

model Reservation {
  id              String    @id @default(uuid())
  tenantId        String
  tableId         String
  customerName    String
  customerPhone   String?
  customerEmail   String?
  reservationTime DateTime
  partySize       Int
  status          String    @default("pending") // 'pending', 'confirmed', 'completed', 'cancelled', 'no-show'
  specialRequests String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  table  HotelTable @relation(fields: [tableId], references: [id])

  @@index([tenantId, reservationTime])
  @@map("reservations")
}

// ============================================
// EXPENSE MODULE TABLES
// ============================================

model Expense {
  id          String   @id @default(uuid())
  tenantId    String
  category    String // 'rent', 'utilities', 'supplies', 'salaries', 'marketing', 'other'
  amount      Decimal  @db.Decimal(10, 2)
  description String?
  date        DateTime @db.Date
  receiptUrl  String?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant  Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator User?  @relation(fields: [createdBy], references: [id])

  @@index([tenantId, date])
  @@map("expenses")
}

// ============================================
// LANDING PAGE MODULE TABLES
// ============================================

model LandingPage {
  id          String   @id @default(uuid())
  tenantId    String
  title       String?
  content     Json? // Store page structure as JSON (blocks/sections)
  theme       String   @default("default")
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant     Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  pageAssets PageAsset[]

  @@index([tenantId])
  @@map("landing_pages")
}

model PageAsset {
  id            String   @id @default(uuid())
  tenantId      String
  landingPageId String
  assetType     String // 'image', 'video', 'document'
  url           String
  altText       String?
  displayOrder  Int      @default(0)
  createdAt     DateTime @default(now())

  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  landingPage LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([tenantId, landingPageId])
  @@map("page_assets")
}

// ============================================
// PLATFORM ADMIN MODULE TABLES
// ============================================

model PlatformAdmin {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  role         String   @default("admin") // 'superadmin', 'admin', 'support'
  firstName    String?
  lastName     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  auditLogs AdminAuditLog[]

  @@map("platform_admins")
}

model AdminAuditLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String   // 'suspend_tenant', 'login', 'create_plan'
  targetType String   // 'tenant', 'user', 'plan'
  targetId   String?
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  admin PlatformAdmin @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@map("admin_audit_logs")
}

// ============================================
// E-COMMERCE MODULE TABLES
// ============================================

model EcommerceCategory {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  slug        String
  description String?
  parentId    String?
  imageUrl    String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parent   EcommerceCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children EcommerceCategory[] @relation("CategoryHierarchy")
  products EcommerceProduct[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("ecommerce_categories")
}

model EcommerceProduct {
  id                String   @id @default(uuid())
  tenantId          String
  categoryId        String?
  name              String
  slug              String
  description       String?
  shortDescription  String?
  sku               String?
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2) // Original price for discounts
  costPrice         Decimal? @db.Decimal(10, 2) // Cost for profit calculation
  stockQuantity     Int      @default(0)
  lowStockThreshold Int      @default(10)
  weight            Decimal? @db.Decimal(8, 2) // For shipping
  isActive          Boolean  @default(true)
  isFeatured        Boolean  @default(false)
  metaTitle         String?
  metaDescription   String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  tenant    Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  category  EcommerceCategory?         @relation(fields: [categoryId], references: [id])
  images    EcommerceProductImage[]
  variants  EcommerceProductVariant[]
  cartItems EcommerceCartItem[]
  orderItems EcommerceOrderItem[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, categoryId])
  @@map("ecommerce_products")
}

model EcommerceProductImage {
  id        String   @id @default(uuid())
  productId String
  url       String
  altText   String?
  sortOrder Int      @default(0)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  product EcommerceProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@map("ecommerce_product_images")
}

model EcommerceProductVariant {
  id            String   @id @default(uuid())
  productId     String
  name          String   // e.g., "Small / Red"
  sku           String?
  price         Decimal? @db.Decimal(10, 2)
  stockQuantity Int      @default(0)
  attributes    Json?    // {"size": "S", "color": "Red"}
  createdAt     DateTime @default(now())

  product    EcommerceProduct    @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems  EcommerceCartItem[]
  orderItems EcommerceOrderItem[]

  @@index([productId])
  @@map("ecommerce_product_variants")
}

model EcommerceCart {
  id         String    @id @default(uuid())
  tenantId   String
  customerId String?
  sessionId  String?   // For guest checkout
  status     String    @default("active") // 'active', 'converted', 'abandoned'
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenant   Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer User?               @relation(fields: [customerId], references: [id])
  items    EcommerceCartItem[]

  @@index([tenantId])
  @@index([sessionId])
  @@map("ecommerce_carts")
}

model EcommerceCartItem {
  id        String   @id @default(uuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int      @default(1)
  unitPrice Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())

  cart    EcommerceCart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product EcommerceProduct         @relation(fields: [productId], references: [id])
  variant EcommerceProductVariant? @relation(fields: [variantId], references: [id])

  @@index([cartId])
  @@map("ecommerce_cart_items")
}

model EcommerceOrder {
  id                    String    @id @default(uuid())
  tenantId              String
  customerId            String?
  orderNumber           String
  status                String    @default("pending") // 'pending', 'confirmed', 'processing', 'shipped', 'delivered', 'cancelled', 'refunded'
  subtotal              Decimal   @db.Decimal(10, 2)
  taxAmount             Decimal   @default(0) @db.Decimal(10, 2)
  shippingAmount        Decimal   @default(0) @db.Decimal(10, 2)
  discountAmount        Decimal   @default(0) @db.Decimal(10, 2)
  total                 Decimal   @db.Decimal(10, 2)
  currency              String    @default("USD")
  
  // Shipping Address
  shippingName          String?
  shippingAddressLine1  String?
  shippingAddressLine2  String?
  shippingCity          String?
  shippingState         String?
  shippingPostalCode    String?
  shippingCountry       String?
  shippingPhone         String?
  
  // Billing Address
  billingName           String?
  billingAddressLine1   String?
  billingAddressLine2   String?
  billingCity           String?
  billingState          String?
  billingPostalCode     String?
  billingCountry        String?
  
  notes                 String?
  couponId              String?
  shippedAt             DateTime?
  deliveredAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  tenant   Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer User?                @relation(fields: [customerId], references: [id])
  coupon   EcommerceCoupon?     @relation(fields: [couponId], references: [id])
  items    EcommerceOrderItem[]
  payments EcommercePayment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@map("ecommerce_orders")
}

model EcommerceOrderItem {
  id          String   @id @default(uuid())
  orderId     String
  productId   String?
  variantId   String?
  productName String   // Snapshot of product name
  variantName String?
  sku         String?
  quantity    Int
  unitPrice   Decimal  @db.Decimal(10, 2)
  totalPrice  Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())

  order   EcommerceOrder           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product EcommerceProduct?        @relation(fields: [productId], references: [id])
  variant EcommerceProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@map("ecommerce_order_items")
}

model EcommerceCoupon {
  id             String    @id @default(uuid())
  tenantId       String
  code           String
  description    String?
  discountType   String    // 'percentage', 'fixed_amount'
  discountValue  Decimal   @db.Decimal(10, 2)
  minOrderAmount Decimal?  @db.Decimal(10, 2)
  maxUses        Int?
  usesCount      Int       @default(0)
  isActive       Boolean   @default(true)
  startsAt       DateTime?
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())

  tenant Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orders EcommerceOrder[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("ecommerce_coupons")
}

model EcommercePayment {
  id              String   @id @default(uuid())
  orderId         String
  amount          Decimal  @db.Decimal(10, 2)
  currency        String   @default("USD")
  status          String   // 'pending', 'completed', 'failed', 'refunded'
  paymentMethod   String?  // 'stripe', 'paypal', 'cod'
  transactionId   String?
  gatewayResponse Json?
  createdAt       DateTime @default(now())

  order EcommerceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@map("ecommerce_payments")
}

